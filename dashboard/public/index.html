<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>BTSAVE</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
  :root {
    --bg: #121016; --card: #1a171f; --border: #2a2530;
    --text: #e8e4ed; --muted: #7a7285; --accent: #f6b06b;
    --green: #6ee7a0; --red: #f87171; --orange: #f6b06b;
    --purple: #c4a6e8;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', system-ui, sans-serif; font-size: 14px; min-height: 100vh; }
  .container { max-width: 480px; margin: 0 auto; padding: 12px; }
  .header { background: linear-gradient(135deg, rgba(246,176,107,0.10) 0%, rgba(110,231,160,0.08) 50%, rgba(248,113,113,0.06) 100%); border: 1px solid rgba(246,176,107,0.15); border-radius: 16px; padding: 16px; margin-bottom: 12px; position: relative; overflow: hidden; }
  .header::before { content: ''; position: absolute; top: -50%; right: -20%; width: 200px; height: 200px; background: radial-gradient(circle, rgba(246,176,107,0.06) 0%, transparent 70%); pointer-events: none; }
  .header-top { display: flex; justify-content: space-between; align-items: flex-start; }
  .header h1 { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
  .header h1 span { background: linear-gradient(135deg, var(--orange), var(--green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  .price-big { font-size: 32px; font-weight: 800; letter-spacing: -1.5px; margin: 4px 0; }
  .price-label { color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
  .step-badge { background: linear-gradient(135deg, var(--orange), var(--red)); color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 700; box-shadow: 0 2px 8px rgba(246,176,107,0.3); }
  .header-stats { display: flex; gap: 12px; margin-top: 12px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); }
  .header-stat { flex: 1; text-align: center; }
  .header-stat-value { font-size: 16px; font-weight: 700; }
  .header-stat-label { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; margin-top: 1px; }
  .chart-wrap { background: var(--card); border-radius: 12px; padding: 12px; margin-bottom: 12px; border: 1px solid var(--border); }
  .chart-wrap canvas { width: 100% !important; height: 220px !important; }
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
  .card { background: var(--card); border-radius: 10px; padding: 12px; border: 1px solid var(--border); }
  .card.full { grid-column: 1 / -1; }
  .card-label { color: var(--muted); font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 4px; }
  .card-value { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }
  .card-sub { color: var(--muted); font-size: 11px; margin-top: 2px; }
  .green { color: var(--green); }
  .red { color: var(--red); }
  .orange { color: var(--orange); }
  .purple { color: var(--purple); }
  .section { background: var(--card); border-radius: 10px; padding: 12px; border: 1px solid var(--border); margin-bottom: 12px; }
  .section h3 { font-size: 12px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--muted); margin-bottom: 8px; }
  .grid-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 12px; }
  .grid-row:last-child { border: none; }
  .action-dir { font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 6px; white-space: nowrap; text-align: center; display: inline-block; }
  .action-dir.up { background: rgba(110,231,160,0.12); color: var(--green); }
  .action-dir.down { background: rgba(248,113,113,0.12); color: var(--red); }
  .grid-col1 { text-align: center; }
  .grid-col2 { font-weight: 600; font-size: 12px; text-align: center; }
  .grid-col3 { text-align: center; }
  .grid-col4 { color: var(--muted); font-size: 11px; text-align: center; }
  .action-mode { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 6px; white-space: nowrap; }
  .action-mode.auto { background: rgba(96,165,250,0.15); color: #60a5fa; }
  .action-mode.manuel { background: rgba(246,176,107,0.15); color: #f6b06b; }
  .hf-bar { height: 6px; border-radius: 3px; background: var(--border); margin-top: 6px; overflow: hidden; }
  .hf-fill { height: 100%; border-radius: 3px; transition: width 0.5s; }
  .footer { text-align: center; color: var(--muted); font-size: 10px; padding: 8px 0 20px; }
  .loading { text-align: center; padding: 40px; color: var(--muted); }
  .dot-pulse { display: inline-block; animation: pulse 1.5s infinite; }
  @keyframes pulse { 0%,100% { opacity: 0.3; } 50% { opacity: 1; } }
  .live-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: var(--green); margin-right: 4px; animation: blink 2s infinite; }
  @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
  .nav-toggle { display: flex; gap: 4px; justify-content: center; margin-top: 8px; }
  .nav-btn { padding: 3px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; text-decoration: none; border: 1px solid var(--border); color: var(--muted); background: transparent; cursor: pointer; transition: all 0.2s; letter-spacing: 0.5px; }
  .nav-btn.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
  .nav-btn:not(.active):hover { border-color: var(--muted); color: var(--text); }
</style>
</head>
<body>
<div class="container" id="app">
  <div class="loading"><span class="dot-pulse">Chargement...</span></div>
</div>

<script>
const $ = s => document.querySelector(s);
const fmt = n => n.toLocaleString('fr-FR');
const fmtUSD = n => '$' + fmt(Math.round(n));
const fmtBTC = (n, d=4) => n.toFixed(d) + ' BTC';

let chart = null;

async function load() {
  try {
    const basePath = location.pathname.replace(/\/+$/, '');
    const res = await fetch(basePath + '/api/data');
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    render(d);
  } catch(e) {
    $('#app').innerHTML = '<div class="loading" style="color:var(--red)">Erreur: ' + e.message + '</div>';
  }
}

function buildNextActions(d) {
  if (!d.steps || !d.steps.length) return '';
  const orders = d.deribit ? d.deribit.orders : [];
  const maxReached = d.maxStepReached || d.currentStep;
  
  const rows = [];
  
  // HAUSSE: 2 nearest steps with BUY orders ‚Üí always AUTO, show trigger (lo)
  const upSteps = d.steps
    .filter(s => s.step <= d.currentStep && orders.some(o => {
      const op = o.trigger || o.price;
      return o.direction === 'buy' && (op === s.lo || op === s.hi || op === s.prix);
    }))
    .sort((a, b) => a.step - b.step)
    .slice(-2);
  for (const s of upSteps) {
    rows.push(`<div class="grid-row">
      <span class="grid-col1"><span class="action-dir up">‚ñ≤ HAUSSE</span></span>
      <span class="grid-col2">${fmtUSD(s.lo)}</span>
      <span class="grid-col3"><span class="action-mode auto">AUTO</span></span>
      <span class="grid-col4">Step ${s.step - 1}</span>
    </div>`);
  }
  
  // BAISSE: 2 next steps never crossed (step > maxReached) ‚Üí always MANUEL, show prix th√©orique
  const downSteps = d.steps
    .filter(s => s.step > maxReached)
    .sort((a, b) => a.step - b.step)
    .slice(0, 2);
  for (const s of downSteps) {
    rows.push(`<div class="grid-row">
      <span class="grid-col1"><span class="action-dir down">‚ñº BAISSE</span></span>
      <span class="grid-col2">${fmtUSD(s.prix)}</span>
      <span class="grid-col3"><span class="action-mode manuel">MANUEL</span></span>
      <span class="grid-col4">Step ${s.step}</span>
    </div>`);
  }
  
  return rows.join('');
}

function render(d) {
  const a = d.aave;
  const pctFromATH = ((d.price - d.ATH) / d.ATH * 100).toFixed(1);
  
  // Health factor color & bar
  let hfColor = 'green', hfWidth = 100;
  if (a) {
    if (a.healthFactor < 1.5) { hfColor = 'red'; hfWidth = 25; }
    else if (a.healthFactor < 2.0) { hfColor = 'orange'; hfWidth = 50; }
    else if (a.healthFactor < 3.0) { hfWidth = 70; }
    else { hfWidth = 90; }
  }

  // LTV percentage
  const ltvPct = a ? (a.totalDebtUSD / a.totalCollateralUSD * 100).toFixed(1) : '‚Äî';

  $('#app').innerHTML = `
    <div class="header">
      <div class="header-top">
        <div>
          <img src="logo.svg" alt="BTSAVE" style="height:30px">
          <div class="nav-toggle">
            <a href="/" class="nav-btn active">PROD</a>
            <a href="/simu.html" class="nav-btn">SIMU</a>
          </div>
        </div>
        <div style="text-align:right">
          <div class="step-badge">Step ${d.currentStep}/19</div>
          <div style="font-size:10px;color:var(--muted);margin-top:4px">PAS/3 ¬∑ $${d.PAS/3 | 0}</div>
        </div>
      </div>
      <div style="display:flex;justify-content:center;align-items:baseline;gap:12px;margin:10px 0 6px">
        <div class="price-big">${fmtUSD(d.price)}</div>
        <div style="color:var(--red);font-size:15px;font-weight:700">${pctFromATH}%</div>
      </div>
      <div class="header-stats">
        <div class="header-stat">
          <div class="header-stat-value">${d.currentStep}</div>
          <div class="header-stat-label">Paliers franchis</div>
        </div>
        <div class="header-stat">
          <div class="header-stat-value">${fmtUSD(d.ATH)}</div>
          <div class="header-stat-label">ATH R√©f.</div>
        </div>
        <div class="header-stat">
          <div class="header-stat-value">${fmtUSD(d.PAS)}</div>
          <div class="header-stat-label">Pas (5%)</div>
        </div>
      </div>
    </div>
    
    ${d.eth ? `
    <div style="display:flex;justify-content:space-between;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:12px">
      <div style="display:flex;align-items:center;gap:6px">
        <span style="font-size:14px">‚ü†</span>
        <div>
          <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px">Solde ETH</div>
          <div style="font-weight:700;font-size:15px">${d.eth.ethBalance.toFixed(4)} ETH</div>
        </div>
      </div>
      <div style="text-align:right">
        <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px">Gas (swap)</div>
        <div style="font-weight:700;font-size:15px">${d.eth.gasPriceGwei} gwei <span style="color:var(--muted);font-size:12px;font-weight:400">‚âà $${d.eth.swapCostUSD.toFixed(2)}</span></div>
      </div>
    </div>
    ` : ''}
    <div class="chart-wrap"><canvas id="chart"></canvas></div>
    
    ${a ? `
    <div class="section" style="padding:0;overflow:hidden">
      <div style="background:${hfColor === 'green' ? 'rgba(110,231,160,0.18)' : hfColor === 'orange' ? 'rgba(246,176,107,0.25)' : 'rgba(248,113,113,0.25)'};padding:8px 12px;display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;opacity:0.9">üè¶ AAVE V3 ‚Äî Health Factor</span>
        <span style="font-size:20px;font-weight:800">${a.healthFactor.toFixed(2)}</span>
      </div>
      <div style="padding:12px">
        <div style="display:flex;gap:12px">
          <div style="flex:1;display:flex;flex-direction:column">
            <div class="card-label" style="margin-bottom:8px;color:var(--green)">‚ú¶ ACTIF</div>
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
              <span style="font-size:16px">‚Çø</span>
              <div>
                <div style="font-weight:700;font-size:14px">${fmtBTC(a.wbtcBTC)}</div>
              </div>
            </div>
            <div style="display:flex;align-items:center;gap:6px">
              <span style="font-size:16px">üíµ</span>
              <div>
                <div style="font-weight:700;font-size:14px">${fmtUSD(a.usdtCol)} <span class="card-sub">USDT</span></div>
              </div>
            </div>
            <div style="flex:1"></div>
            <div style="padding-top:6px;border-top:1px solid var(--border)">
              <div class="card-sub">Total</div>
              <div style="font-weight:700">${fmtUSD(a.totalCollateralUSD)}</div>
            </div>
          </div>
          <div style="width:1px;background:var(--border)"></div>
          <div style="flex:1;display:flex;flex-direction:column">
            <div class="card-label" style="margin-bottom:8px;color:var(--red)">‚ú¶ PASSIF</div>
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
              <span style="font-size:16px">üíµ</span>
              <div>
                <div style="font-weight:700;font-size:14px">${fmtUSD(a.debtUSDT)} <span class="card-sub">USDT</span></div>
              </div>
            </div>
            ${a.totalDebtUSD - a.debtUSDT > 100 ? `
            <div style="display:flex;align-items:center;gap:6px">
              <span style="font-size:16px">üíµ</span>
              <div>
                <div style="font-weight:700;font-size:14px">${fmtUSD(a.totalDebtUSD - a.debtUSDT)} <span class="card-sub">USDC</span></div>
              </div>
            </div>` : ''}
            <div style="flex:1"></div>
            <div style="padding-top:6px;border-top:1px solid var(--border)">
              <div class="card-sub">Total</div>
              <div style="font-weight:700;color:var(--red)">${fmtUSD(a.totalDebtUSD)}</div>
            </div>
          </div>
        </div>
        <div style="margin-top:10px;display:flex;justify-content:space-between;font-size:11px;color:var(--muted)">
          <span>LTV: ${ltvPct}%</span>
          <span>Net: ${fmtUSD(a.totalCollateralUSD - a.totalDebtUSD)}</span>
          <span class="orange">Liq: ${fmtUSD(d.price / a.healthFactor * (a.liquidationThreshold / 10000))}</span>
        </div>
      </div>
    </div>
    
    ${a.athBreakdown ? `
    <div class="section">
      <h3>üéØ Total BTC @ ATH (${fmtUSD(d.ATH)})</h3>
      <div class="grid" style="margin-bottom:0">
        <div class="card full" style="border:1px solid rgba(110,231,160,0.25);text-align:center">
          <div class="card-label">BTC ATH</div>
          <div class="card-value green" style="font-size:22px">${fmtBTC(a.athBreakdown.totalBtc)}</div>
          <div class="card-sub">${fmtUSD(a.athBreakdown.totalUSD)}</div>
        </div>
        <div class="card">
          <div class="card-label">P1 ‚Äî Collat√©ral</div>
          <div class="card-value">${fmtBTC(a.athBreakdown.p1Btc)}</div>
          <div class="card-sub">apr√®s restitution ${a.athBreakdown.extraReturned} BTC</div>
        </div>
        <div class="card">
          <div class="card-label">P2 ‚Äî Accumulation</div>
          <div class="card-value green">+${fmtBTC(a.athBreakdown.p2Net)}</div>
          <div class="card-sub">${fmtBTC(a.athBreakdown.p2Btc)} achet√©s ‚àí ${fmtBTC(a.athBreakdown.debtRepayBtc)} remb.</div>
        </div>
      </div>
    </div>
    ` : ''}
    <div class="section">
      <h3>üìà Grid Gains</h3>
      <div style="text-align:center">
        <div class="card-value ${d.deribit.gridGains.totalPnl >= 0 ? 'green' : 'red'}" style="font-size:22px">${d.deribit.gridGains.totalPnl >= 0 ? '+' : ''}${d.deribit.gridGains.totalPnl.toFixed(2)} USDC</div>
        <div class="card-sub">${d.deribit.gridGains.tradeCount} trades ex√©cut√©s</div>
      </div>
    </div>
    ` : `
    <div class="section"><h3>üè¶ AAVE</h3><div class="card-sub">Donn√©es indisponibles</div></div>
    `}
    
    <div class="section">
      <h3>üìä Deribit</h3>
      <div class="grid" style="margin-bottom:0">
        <div class="card" style="text-align:center">
          <div class="card-label">Equity</div>
          <div class="card-value">${d.deribit.equity.toFixed(2)}</div>
          <div class="card-sub">USDC</div>
        </div>
        <div class="card" style="text-align:center">
          <div class="card-label">Disponible</div>
          <div class="card-value">${d.deribit.available.toFixed(2)}</div>
          <div class="card-sub">USDC</div>
        </div>
      </div>
      ${d.deribit.orders.length ? `
      <div style="margin-top:10px">
        <div class="card-label" style="margin-bottom:6px">Ordres ouverts (${d.deribit.orders.length})</div>
        ${d.deribit.orders.sort((a,b) => (b.trigger||b.price) - (a.trigger||a.price)).map(o => `
          <div class="grid-row">
            <span class="grid-col1"><span class="action-dir ${o.direction === 'buy' ? 'up' : 'down'}">${o.direction.toUpperCase()}</span></span>
            <span class="grid-col2">${o.trigger ? '‚ö°'+fmt(o.trigger) : fmtUSD(o.price)}</span>
            <span class="grid-col3" style="color:var(--muted)">${o.amount} BTC</span>
            <span class="grid-col4">${o.type}</span>
          </div>
        `).join('')}
      </div>` : ''}
      ${d.deribit.positions.length ? `
      <div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--border)">
        <div class="card-label" style="margin-bottom:6px">Positions ouvertes</div>
        ${d.deribit.positions.map(p => `
          <div class="grid-row">
            <span class="grid-col1"><span class="action-dir ${p.direction === 'buy' ? 'up' : 'down'}">${p.direction.toUpperCase()}</span></span>
            <span class="grid-col2">${p.size} BTC</span>
            <span class="grid-col3 ${p.pnl >= 0 ? 'green' : 'red'}">${p.pnl >= 0 ? '+' : ''}${p.pnl.toFixed(2)}</span>
            ${d.role === 'admin' ? `<button id="close-${p.instrument.replace(/[^a-zA-Z0-9]/g,'')}" onclick="closePosition('${p.instrument}', this)" style="background:var(--red);color:#fff;border:none;border-radius:6px;padding:4px 12px;font-size:11px;font-weight:700;cursor:pointer;-webkit-tap-highlight-color:transparent">STOP</button>` : `<span class="grid-col4"></span>`}
          </div>
        `).join('')}
      </div>` : ''}
    </div>
    
    <div class="section">
      <h3>üéØ Prochaines actions</h3>
      ${buildNextActions(d)}
    </div>
    
    <div class="footer">
      <span class="live-dot"></span> Mis √† jour: ${new Date().toLocaleString('fr-FR')} ‚Äî Auto-refresh 60s<br>
      BTSAVE ‚Äî On-chain data via Ethereum RPC
    </div>
  `;
  
  drawChart(d);
}

function drawChart(d) {
  const canvas = document.getElementById('chart');
  if (!canvas || !d.priceHistory || !d.priceHistory.length) return;
  
  // OHLC candlestick data
  const candles = d.priceHistory.map(p => ({
    x: p.t,
    o: p.o,
    h: p.h,
    l: p.l,
    c: p.c
  }));
  
  const annotations = {};
  const orders = d.deribit ? d.deribit.orders : [];
  const maxReached = d.maxStepReached || d.currentStep;
  
  // Next up: nearest step with a BUY order (lowest lo above or near price)
  const upStep = d.steps
    .filter(s => s.step <= d.currentStep && orders.some(o => o.direction === 'buy' && ((o.trigger || o.price) === s.lo || (o.trigger || o.price) === s.hi)))
    .sort((a, b) => a.lo - b.lo)[0];
  if (upStep) {
    annotations.nextUp = {
      type: 'line', yMin: upStep.lo, yMax: upStep.lo,
      borderColor: 'rgba(110,231,160,0.6)', borderWidth: 2, borderDash: [6,3],
      label: { display: true, content: '‚ñ≤ ' + fmt(upStep.lo), position: 'end', backgroundColor: 'rgba(110,231,160,0.15)', color: '#6ee7a0', font: { size: 10 } }
    };
  }
  
  // Next down: nearest first-crossing step (prix th√©orique)
  const downStep = d.steps
    .filter(s => s.step > maxReached)
    .sort((a, b) => a.step - b.step)[0];
  if (downStep) {
    annotations.nextDown = {
      type: 'line', yMin: downStep.prix, yMax: downStep.prix,
      borderColor: 'rgba(248,113,113,0.6)', borderWidth: 2, borderDash: [6,3],
      label: { display: true, content: '‚ñº ' + fmt(downStep.prix), position: 'end', backgroundColor: 'rgba(248,113,113,0.15)', color: '#f87171', font: { size: 10 } }
    };
  }
  
  // Current price
  annotations.current = {
    type: 'line', yMin: d.price, yMax: d.price,
    borderColor: 'rgba(246,176,107,0.8)', borderWidth: 1.5,
    label: { display: true, content: fmt(Math.round(d.price)), position: 'start', backgroundColor: 'rgba(246,176,107,0.3)', color: '#f6b06b', font: { size: 10, weight: 'bold' } }
  };
  
  // Ensure Y axis always includes annotation levels
  const yValues = candles.flatMap(c => [c.h, c.l]);
  if (upStep) yValues.push(upStep.lo);
  if (downStep) yValues.push(downStep.prix);
  const suggestedMin = Math.min(...yValues);
  const suggestedMax = Math.max(...yValues);
  const chartMin = suggestedMin;
  const chartMax = suggestedMax;

  if (chart) chart.destroy();
  
  // Use candlestick if available, fallback to line
  const hasCandlestick = typeof Chart.controllers.candlestick !== 'undefined';
  
  if (hasCandlestick) {
    chart = new Chart(canvas, {
      type: 'candlestick',
      data: {
        datasets: [{
          data: candles,
          color: { up: '#6ee7a0', down: '#f87171', unchanged: '#7a7285' },
          borderColor: { up: '#6ee7a0', down: '#f87171', unchanged: '#7a7285' },
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false },
          annotation: { annotations }
        },
        scales: {
          x: {
            type: 'timeseries',
            time: { unit: 'hour', displayFormats: { hour: 'dd/MM HH:mm' } },
            ticks: { color: '#7a7285', font: { size: 9 }, maxTicksLimit: 6, maxRotation: 0 },
            grid: { display: false }
          },
          y: {
            display: true,
            min: chartMin, max: chartMax,
            ticks: { color: '#7a7285', font: { size: 9 }, callback: v => fmt(Math.round(v)), maxTicksLimit: 6 },
            grid: { color: 'rgba(42,37,48,0.5)' }
          }
        }
      }
    });
  } else {
    // Fallback: draw candles manually on a line chart
    const closes = candles.map(c => ({ x: c.x, y: c.c }));
    chart = new Chart(canvas, {
      type: 'line',
      data: {
        datasets: [{
          data: closes,
          borderColor: '#f6b06b',
          backgroundColor: 'rgba(246,176,107,0.08)',
          borderWidth: 1.5,
          fill: true,
          pointRadius: 0,
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          annotation: { annotations },
          tooltip: { enabled: false }
        },
        scales: {
          x: {
            type: 'linear',
            ticks: {
              callback: v => { const dt = new Date(v); return dt.getDate() + '/' + (dt.getMonth()+1) + ' ' + dt.getHours() + 'h'; },
              color: '#7a7285', font: { size: 9 }, maxTicksLimit: 6, maxRotation: 0
            },
            grid: { display: false }
          },
          y: {
            display: true,
            min: chartMin, max: chartMax,
            ticks: { color: '#7a7285', font: { size: 9 }, callback: v => fmt(Math.round(v)), maxTicksLimit: 6 },
            grid: { color: 'rgba(42,37,48,0.5)' }
          }
        },
        interaction: { intersect: false, mode: 'index' }
      }
    });

    // Draw candles as overlay
    const meta = chart.getDatasetMeta(0);
    const yScale = chart.scales.y;
    const xScale = chart.scales.x;
    const ctx2 = canvas.getContext('2d');
    
    const candlePlugin = {
      id: 'candlesticks',
      afterDatasetDraw(ch) {
        const ctx = ch.ctx;
        const ys = ch.scales.y;
        const xs = ch.scales.x;
        const barW = Math.max(2, (xs.width / candles.length) * 0.6);
        
        candles.forEach(c => {
          const x = xs.getPixelForValue(c.x);
          const oY = ys.getPixelForValue(c.o);
          const cY = ys.getPixelForValue(c.c);
          const hY = ys.getPixelForValue(c.h);
          const lY = ys.getPixelForValue(c.l);
          const bull = c.c >= c.o;
          const color = bull ? '#6ee7a0' : '#f87171';
          
          // Wick
          ctx.beginPath();
          ctx.strokeStyle = color;
          ctx.lineWidth = 1;
          ctx.moveTo(x, hY);
          ctx.lineTo(x, lY);
          ctx.stroke();
          
          // Body
          const top = Math.min(oY, cY);
          const h = Math.max(1, Math.abs(oY - cY));
          ctx.fillStyle = bull ? 'rgba(110,231,160,0.8)' : 'rgba(248,113,113,0.8)';
          ctx.fillRect(x - barW/2, top, barW, h);
        });
      }
    };
    
    chart.config.plugins = [candlePlugin];
    chart.update();
  }
}

let closeConfirm = {};
async function closePosition(instrument, btn) {
  // First tap: arm confirmation
  if (!closeConfirm[instrument] || Date.now() - closeConfirm[instrument] > 3000) {
    closeConfirm[instrument] = Date.now();
    btn.textContent = 'CONFIRMER';
    btn.style.background = '#dc4444';
    setTimeout(() => { if (btn.textContent === 'CONFIRMER') { btn.textContent = 'STOP'; btn.style.background = 'var(--red)'; } }, 3000);
    return;
  }
  // Second tap: close
  closeConfirm[instrument] = 0;
  btn.textContent = '...';
  btn.disabled = true;
  try {
    const basePath = location.pathname.replace(/\/+$/, '');
    const res = await fetch(basePath + '/api/close-position', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ instrument })
    });
    const d = await res.json();
    if (d.ok) {
      btn.textContent = '‚úì';
      btn.style.background = 'var(--green)';
      setTimeout(load, 1500);
    } else {
      btn.textContent = d.error || 'ERREUR';
      btn.style.background = 'var(--orange)';
      setTimeout(() => { btn.textContent = 'STOP'; btn.style.background = 'var(--red)'; btn.disabled = false; }, 3000);
    }
  } catch (e) {
    btn.textContent = 'ERREUR';
    btn.style.background = 'var(--orange)';
    setTimeout(() => { btn.textContent = 'STOP'; btn.style.background = 'var(--red)'; btn.disabled = false; }, 3000);
  }
}

load();
setInterval(load, 60000);
</script>
</body>
</html>
