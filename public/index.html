<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>BTSAVE Finale Ultime</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
  :root {
    --bg: #121016; --card: #1a171f; --border: #2a2530;
    --text: #e8e4ed; --muted: #7a7285; --accent: #f6b06b;
    --green: #6ee7a0; --red: #f87171; --orange: #f6b06b;
    --purple: #c4a6e8; --blue: #60a5fa;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', system-ui, sans-serif; font-size: 14px; min-height: 100vh; }
  .container { max-width: 480px; margin: 0 auto; padding: 12px; }
  .header { background: linear-gradient(135deg, rgba(246,176,107,0.10) 0%, rgba(110,231,160,0.08) 50%, rgba(248,113,113,0.06) 100%); border: 1px solid rgba(246,176,107,0.15); border-radius: 16px; padding: 16px; margin-bottom: 12px; position: relative; overflow: hidden; }
  .header::before { content: ''; position: absolute; top: -50%; right: -20%; width: 200px; height: 200px; background: radial-gradient(circle, rgba(246,176,107,0.06) 0%, transparent 70%); pointer-events: none; }
  .header-top { display: flex; justify-content: space-between; align-items: flex-start; }
  .header h1 { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
  .header h1 span { background: linear-gradient(135deg, var(--orange), var(--green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  .price-big { font-size: 32px; font-weight: 800; letter-spacing: -1.5px; margin: 4px 0; }
  .price-label { color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
  .step-badge { background: linear-gradient(135deg, var(--orange), var(--red)); color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 700; box-shadow: 0 2px 8px rgba(246,176,107,0.3); }
  .header-stats { display: flex; gap: 12px; margin-top: 12px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); }
  .header-stat { flex: 1; text-align: center; }
  .header-stat-value { font-size: 16px; font-weight: 700; }
  .header-stat-label { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; margin-top: 1px; }
  .chart-wrap { background: var(--card); border-radius: 12px; padding: 12px; margin-bottom: 12px; border: 1px solid var(--border); }
  .chart-wrap canvas { width: 100% !important; height: 220px !important; }
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
  .card { background: var(--card); border-radius: 10px; padding: 12px; border: 1px solid var(--border); }
  .card.full { grid-column: 1 / -1; }
  .card-label { color: var(--muted); font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 4px; }
  .card-value { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }
  .card-sub { color: var(--muted); font-size: 11px; margin-top: 2px; }
  .green { color: var(--green); }
  .red { color: var(--red); }
  .orange { color: var(--orange); }
  .purple { color: var(--purple); }
  .blue { color: var(--blue); }
  .section { background: var(--card); border-radius: 10px; padding: 12px; border: 1px solid var(--border); margin-bottom: 12px; }
  .section h3 { font-size: 12px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--muted); margin-bottom: 8px; }
  .grid-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 12px; }
  .grid-row:last-child { border: none; }
  .action-dir { font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 6px; white-space: nowrap; text-align: center; display: inline-block; }
  .action-dir.up { background: rgba(110,231,160,0.12); color: var(--green); }
  .action-dir.down { background: rgba(248,113,113,0.12); color: var(--red); }
  .grid-col1 { text-align: center; }
  .grid-col2 { font-weight: 600; font-size: 12px; text-align: center; }
  .grid-col3 { text-align: center; }
  .grid-col4 { color: var(--muted); font-size: 11px; text-align: center; }
  .hf-bar { height: 6px; border-radius: 3px; background: var(--border); margin-top: 6px; overflow: hidden; }
  .hf-fill { height: 100%; border-radius: 3px; transition: width 0.5s; }
  .footer { text-align: center; color: var(--muted); font-size: 10px; padding: 8px 0 20px; }
  .loading { text-align: center; padding: 40px; color: var(--muted); }
  .dot-pulse { display: inline-block; animation: pulse 1.5s infinite; }
  @keyframes pulse { 0%,100% { opacity: 0.3; } 50% { opacity: 1; } }
  .live-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: var(--green); margin-right: 4px; animation: blink 2s infinite; }
  @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
  .nav-toggle { display: flex; gap: 4px; justify-content: center; margin-top: 8px; }
  .nav-btn { padding: 3px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; text-decoration: none; border: 1px solid var(--border); color: var(--muted); background: transparent; cursor: pointer; transition: all 0.2s; letter-spacing: 0.5px; }
  .nav-btn.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
  .nav-btn:not(.active):hover { border-color: var(--muted); color: var(--text); }
  .strat-var { display: flex; justify-content: space-between; padding: 4px 0; font-size: 12px; border-bottom: 1px solid var(--border); }
  .strat-var:last-child { border: none; }
  .strat-var .label { color: var(--muted); }
  .strat-var .val { font-weight: 700; }
  .zone-item { padding: 8px 10px; border-radius: 8px; margin-bottom: 4px; font-size: 12px; border: 1px solid transparent; opacity: 0.5; }
  .zone-item.active { opacity: 1; border-color: var(--accent); background: rgba(246,176,107,0.08); }
  .zone-item .zone-price { font-weight: 700; }
  .split-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; margin: 8px 0; }
  .split-bar .seg-wbtc { background: var(--orange); }
  .split-bar .seg-aave { background: var(--blue); }
  .split-bar .seg-deribit { background: var(--purple); }
  .split-legend { display: flex; gap: 12px; justify-content: center; font-size: 10px; }
  .split-legend span { display: flex; align-items: center; gap: 4px; }
  .split-legend .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
  .option-row { padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 12px; }
  .option-row:last-child { border: none; }
</style>
</head>
<body>
<div class="container" id="app">
  <div class="loading"><span class="dot-pulse">Chargement...</span></div>
</div>

<script>
const $ = s => document.querySelector(s);
const fmt = n => n.toLocaleString('fr-FR');
const fmtUSD = n => '$' + fmt(Math.round(n));
const fmtBTC = (n, d=4) => n.toFixed(d) + ' BTC';

let chart = null;

async function load() {
  try {
    const basePath = location.pathname.replace(/\/+$/, '');
    const res = await fetch(basePath + '/api/data');
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    render(d);
  } catch(e) {
    $('#app').innerHTML = '<div class="loading" style="color:var(--red)">Erreur: ' + e.message + '</div>';
  }
}

function render(d) {
  const a = d.aave;
  const s = d.strategy;
  const r = d.repartition;
  const pctFromATH = ((d.price - d.ATH) / d.ATH * 100).toFixed(1);
  
  let hfColor = 'green';
  if (a) {
    if (a.healthFactor < 1.5) hfColor = 'red';
    else if (a.healthFactor < 2.0) hfColor = 'orange';
  }

  const ltvPct = a ? (a.totalDebtUSD / a.totalCollateralUSD * 100).toFixed(1) : '‚Äî';

  // Zone thresholds
  // Health Factor based zones (new Finale Ultime strategy)
  const zones = [
    { id: 'accumulation', label: '‚úÖ Accumulation normale', condition: 'HF ‚â• 1.50', hf: '1.50+' },
    { id: 'monitor', label: 'üëÅÔ∏è Monitor renforc√©', condition: 'HF 1.40 √† 1.50', hf: '1.40-1.50' },
    { id: 'stop', label: 'üõë STOP nouveaux emprunts', condition: 'HF < 1.40', hf: '<1.40' },
    { id: 'zone1', label: '‚ö†Ô∏è Vendre 50% puts + rembourser 25% dette', condition: 'HF 1.30', hf: '1.30' },
    { id: 'zone2', label: 'üî∂ Vendre puts restants + rembourser 40% dette', condition: 'HF 1.25', hf: '1.25' },
    { id: 'emergency', label: 'üö® Vendre tout + rembourser max', condition: 'HF < 1.15', hf: '<1.15' },
  ];

  $('#app').innerHTML = `
    <div class="header">
      <div class="header-top">
        <div>
          <img src="logo.svg" alt="BTSAVE" style="height:30px">
          <div class="nav-toggle">
            <a href="/" class="nav-btn active">PROD</a>
            <a href="/simu.html" class="nav-btn">SIMU</a>
          </div>
        </div>
        <div style="text-align:right">
          <div class="step-badge">Step ${d.currentStep}/19</div>
          <div style="font-size:9px;color:var(--muted);margin-top:4px">${s.split}</div>
        </div>
      </div>
      <div style="display:flex;justify-content:center;align-items:baseline;gap:12px;margin:10px 0 6px">
        <div class="price-big">${fmtUSD(d.price)}</div>
        <div style="color:var(--red);font-size:15px;font-weight:700">${pctFromATH}%</div>
      </div>
      ${r ? `
      <div class="split-bar">
        <div class="seg-wbtc" style="width:${r.wbtcPct}%"></div>
        <div class="seg-aave" style="width:${r.usdcAavePct}%"></div>
        <div class="seg-deribit" style="width:${r.usdcDeribitPct}%"></div>
      </div>
      <div class="split-legend">
        <span><span class="dot" style="background:var(--orange)"></span> WBTC ${r.wbtcPct}%</span>
        <span><span class="dot" style="background:var(--blue)"></span> USDC AAVE ${r.usdcAavePct}%</span>
        <span><span class="dot" style="background:var(--purple)"></span> USDC Deribit ${r.usdcDeribitPct}%</span>
      </div>
      <div style="text-align:center;font-size:10px;color:var(--muted);margin-top:4px">D√©but de cycle: 79 / 18 / 3</div>
      ` : ''}
      <div class="header-stats">
        <div class="header-stat">
          <div class="header-stat-value">${fmtUSD(d.ATH)}</div>
          <div class="header-stat-label">ATH Ratchet√©</div>
        </div>
        <div class="header-stat">
          <div class="header-stat-value">${fmtUSD(d.stepSize)}</div>
          <div class="header-stat-label">Pas (5%)</div>
        </div>
        <div class="header-stat">
          <div class="header-stat-value">${s.wbtcStart}</div>
          <div class="header-stat-label">WBTC Start</div>
        </div>
      </div>
    </div>

    <!-- Strategy Variables -->
    <div class="section">
      <h3>‚öôÔ∏è Param√®tres du cycle</h3>
      <div class="strat-var"><span class="label">Buffer USDC AAVE</span><span class="val">${fmtUSD(s.bufferUsdcAave)}</span></div>
      <div class="strat-var"><span class="label">USDC Deribit cible</span><span class="val">${fmtUSD(s.usdcDeribitTarget)}</span></div>
      <div class="strat-var"><span class="label">Emprunt / palier</span><span class="val">${fmtUSD(s.borrowPerStep)}</span></div>
      <div class="strat-var"><span class="label">Short / palier</span><span class="val">${s.shortPerStep} BTC</span></div>
    </div>

    ${d.eth ? `
    <div style="display:flex;justify-content:space-between;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:12px">
      <div style="display:flex;align-items:center;gap:6px">
        <span style="font-size:14px">‚ü†</span>
        <div>
          <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px">Solde ETH</div>
          <div style="font-weight:700;font-size:15px">${d.eth.ethBalance.toFixed(4)} ETH</div>
        </div>
      </div>
      <div style="text-align:right">
        <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px">Gas (swap)</div>
        <div style="font-weight:700;font-size:15px">${d.eth.gasPriceGwei} gwei <span style="color:var(--muted);font-size:12px;font-weight:400">‚âà $${d.eth.swapCostUSD.toFixed(2)}</span></div>
      </div>
    </div>
    ` : ''}

    <div class="chart-wrap"><canvas id="chart"></canvas></div>
    
    ${a ? `
    <div class="section" style="padding:0;overflow:hidden">
      <div style="background:${hfColor === 'green' ? 'rgba(110,231,160,0.18)' : hfColor === 'orange' ? 'rgba(246,176,107,0.25)' : 'rgba(248,113,113,0.25)'};padding:8px 12px;display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;opacity:0.9">üè¶ AAVE V3 ‚Äî Health Factor</span>
        <span style="font-size:20px;font-weight:800">${a.healthFactor.toFixed(2)}</span>
      </div>
      <div style="padding:12px">
        <div style="display:flex;gap:12px">
          <div style="flex:1;display:flex;flex-direction:column">
            <div class="card-label" style="margin-bottom:8px;color:var(--green)">‚ú¶ ACTIF</div>
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
              <span style="font-size:16px">‚Çø</span>
              <div>
                <div style="font-weight:700;font-size:14px">${fmtBTC(a.wbtcBTC)}</div>
              </div>
            </div>
            ${a.usdcCol > 100 ? `
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
              <span style="font-size:16px">üíµ</span>
              <div>
                <div style="font-weight:700;font-size:14px">${fmtUSD(a.usdcCol)} <span class="card-sub">USDC</span></div>
              </div>
            </div>` : ''}
            ${a.usdtCol > 100 ? `
            <div style="display:flex;align-items:center;gap:6px">
              <span style="font-size:16px">üíµ</span>
              <div>
                <div style="font-weight:700;font-size:14px">${fmtUSD(a.usdtCol)} <span class="card-sub">USDT</span></div>
              </div>
            </div>` : ''}
            <div style="flex:1"></div>
            <div style="padding-top:6px;border-top:1px solid var(--border)">
              <div class="card-sub">Total</div>
              <div style="font-weight:700">${fmtUSD(a.totalCollateralUSD)}</div>
            </div>
          </div>
          <div style="width:1px;background:var(--border)"></div>
          <div style="flex:1;display:flex;flex-direction:column">
            <div class="card-label" style="margin-bottom:8px;color:var(--red)">‚ú¶ PASSIF</div>
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
              <span style="font-size:16px">üíµ</span>
              <div>
                <div style="font-weight:700;font-size:14px">${fmtUSD(a.debtUSDT)} <span class="card-sub">USDT</span></div>
              </div>
            </div>
            ${a.totalDebtUSD - a.debtUSDT > 100 ? `
            <div style="display:flex;align-items:center;gap:6px">
              <span style="font-size:16px">üíµ</span>
              <div>
                <div style="font-weight:700;font-size:14px">${fmtUSD(a.totalDebtUSD - a.debtUSDT)} <span class="card-sub">USDC</span></div>
              </div>
            </div>` : ''}
            <div style="flex:1"></div>
            <div style="padding-top:6px;border-top:1px solid var(--border)">
              <div class="card-sub">Total</div>
              <div style="font-weight:700;color:var(--red)">${fmtUSD(a.totalDebtUSD)}</div>
            </div>
          </div>
        </div>
        <div style="margin-top:10px;display:flex;justify-content:space-between;font-size:11px;color:var(--muted)">
          <span>LTV: ${ltvPct}%</span>
          <span>Net: ${fmtUSD(a.totalCollateralUSD - a.totalDebtUSD)}</span>
          <span class="orange">Liq: ${fmtUSD(d.price / a.healthFactor * (a.liquidationThreshold / 10000))}</span>
        </div>
      </div>
    </div>
    
    ${a.athBreakdown ? `
    <div class="section">
      <h3>üéØ Total BTC @ ATH (${fmtUSD(d.ATH)})</h3>
      <div class="grid" style="margin-bottom:0">
        <div class="card full" style="border:1px solid rgba(110,231,160,0.25);text-align:center">
          <div class="card-label">BTC Net @ ATH</div>
          <div class="card-value green" style="font-size:22px">${fmtBTC(a.athBreakdown.netBtc)}</div>
          <div class="card-sub">${fmtUSD(a.athBreakdown.netUSD)}</div>
        </div>
        <div class="card">
          <div class="card-label">WBTC actuel</div>
          <div class="card-value">${fmtBTC(a.athBreakdown.currentWbtc)}</div>
          <div class="card-sub">start: ${a.athBreakdown.wbtcStart} | accum: +${fmtBTC(a.athBreakdown.accumulated)}</div>
        </div>
        <div class="card">
          <div class="card-label">Buffer USDC ‚Üí BTC</div>
          <div class="card-value green">+${fmtBTC(a.athBreakdown.bufferBtc)}</div>
          <div class="card-sub">${fmtUSD(a.athBreakdown.bufferUSDC)} / ${fmtUSD(d.ATH)}</div>
        </div>
        <div class="card">
          <div class="card-label">Equity Deribit ‚Üí BTC</div>
          <div class="card-value green">+${fmtBTC(a.athBreakdown.deribitEquityBtc)}</div>
          <div class="card-sub">${fmtUSD(a.athBreakdown.deribitEquityUSDC)} USDC</div>
        </div>
        <div class="card">
          <div class="card-label">Remb. dette en BTC</div>
          <div class="card-value red">‚àí${fmtBTC(a.athBreakdown.debtRepayBtc)}</div>
          <div class="card-sub">${fmtUSD((a.debtUSDT||0) + (a.debtUSDC||0))} / ${fmtUSD(d.ATH)}</div>
        </div>
        <div class="card">
          <div class="card-label">Perte short @ ATH</div>
          <div class="card-value red">‚àí${fmtBTC(a.athBreakdown.shortLossBtc)}</div>
          <div class="card-sub">${fmtUSD(a.athBreakdown.shortLossUSDC)} USDC</div>
        </div>
      </div>
    </div>
    ` : ''}

    <div class="section">
      <h3>üí∞ Funding Rate Gains</h3>
      <div style="text-align:center;margin-bottom:10px">
        <div class="card-value ${d.deribit.fundingGains.totalUSDC >= 0 ? 'green' : 'red'}" style="font-size:22px">${d.deribit.fundingGains.totalUSDC >= 0 ? '+' : ''}${d.deribit.fundingGains.totalUSDC.toFixed(4)} USDC</div>
        <div class="card-sub">${d.deribit.fundingGains.count} settlements ‚Ä¢ Rate: ${d.deribit.fundingGains.rateAnnualPct}% ann. ‚Ä¢ Moy: ${d.deribit.fundingGains.avgPerSettlement.toFixed(4)}/j</div>
        ${d.deribit.fundingGains.resetTimestamp ? `<div class="card-sub" style="margin-top:2px">Depuis: ${new Date(d.deribit.fundingGains.resetTimestamp).toLocaleDateString('fr-FR')}</div>` : ''}
      </div>

      <!-- Next settlement progress -->
      <div style="margin:0 auto 10px;max-width:320px">
        <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-bottom:4px">
          <span>Prochain versement</span>
          <span>${new Date(d.deribit.fundingGains.nextSettlement).toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit',timeZone:'UTC'})} UTC</span>
        </div>
        <div style="background:rgba(255,255,255,0.06);border-radius:4px;height:8px;overflow:hidden">
          <div style="background:linear-gradient(90deg,var(--green),rgba(110,231,160,0.6));height:100%;border-radius:4px;width:${d.deribit.fundingGains.progressPct}%;transition:width 0.5s"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:10px;margin-top:4px">
          <span style="color:var(--muted)">${d.deribit.fundingGains.progressPct}%</span>
          <span style="color:var(--green);font-weight:600">Est. ~${d.deribit.fundingGains.estNextPayout > 0 ? '+' + d.deribit.fundingGains.estNextPayout.toFixed(4) : d.deribit.fundingGains.avgPerSettlement.toFixed(4)} USDC</span>
        </div>
      </div>

      <div style="text-align:center">
        <button onclick="resetFunding()" style="background:rgba(255,107,107,0.15);border:1px solid rgba(255,107,107,0.3);color:var(--red);padding:6px 16px;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600">üîÑ Reset (cash sorti)</button>
      </div>
    </div>
    ` : `
    <div class="section"><h3>üè¶ AAVE</h3><div class="card-sub">Donn√©es indisponibles</div></div>
    `}
    
    <!-- Deribit Section -->
    <div class="section">
      <h3>üìä Deribit</h3>
      <div class="grid" style="margin-bottom:0">
        <div class="card" style="text-align:center">
          <div class="card-label">Equity</div>
          <div class="card-value">${d.deribit.equity.toFixed(2)}</div>
          <div class="card-sub">USDC</div>
        </div>
        <div class="card" style="text-align:center">
          <div class="card-label">Disponible</div>
          <div class="card-value">${d.deribit.available.toFixed(2)}</div>
          <div class="card-sub">USDC</div>
        </div>
      </div>

      ${d.deribit.orders.length ? `
      <div style="margin-top:10px">
        <div class="card-label" style="margin-bottom:6px">Ordres ouverts (${d.deribit.orders.length})</div>
        ${d.deribit.orders.sort((a,b) => (b.trigger||b.price) - (a.trigger||a.price)).map(o => `
          <div class="grid-row">
            <span class="grid-col1"><span class="action-dir ${o.direction === 'buy' ? 'up' : 'down'}">${o.direction.toUpperCase()}</span></span>
            <span class="grid-col2">${o.trigger ? '‚ö°'+fmt(o.trigger) : fmtUSD(o.price)}</span>
            <span class="grid-col3" style="color:var(--muted)">${o.amount} BTC</span>
            <span class="grid-col4">${o.type}</span>
          </div>
        `).join('')}
      </div>` : ''}

      <!-- Futures/Perps Positions -->
      ${d.deribit.futurePositions.length ? `
      <div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--border)">
        <div class="card-label" style="margin-bottom:6px">üìâ Futures / Perps (${d.deribit.futurePositions.length})</div>
        ${d.deribit.futurePositions.map(p => `
          <div class="grid-row">
            <span class="grid-col1"><span class="action-dir ${p.direction === 'buy' ? 'up' : 'down'}">${p.direction.toUpperCase()}</span></span>
            <span class="grid-col2">${p.size} BTC</span>
            <span class="grid-col3 ${p.pnl >= 0 ? 'green' : 'red'}">${p.pnl >= 0 ? '+' : ''}${p.pnl.toFixed(2)}</span>
            ${d.role === 'admin' ? `<button onclick="closePosition('${p.instrument}', this)" style="background:var(--red);color:#fff;border:none;border-radius:6px;padding:4px 12px;font-size:11px;font-weight:700;cursor:pointer">STOP</button>` : `<span class="grid-col4">${p.avgPrice ? fmtUSD(p.avgPrice) : ''}</span>`}
          </div>
        `).join('')}
      </div>` : ''}

      <!-- Options Positions -->
      ${d.deribit.optionPositions.length ? `
      <div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--border)">
        <div class="card-label" style="margin-bottom:6px">üõ°Ô∏è Options (${d.deribit.optionPositions.length})</div>
        ${d.deribit.optionPositions.map(p => `
          <div class="option-row">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <span style="font-weight:700;font-size:13px">${p.optionType === 'P' ? 'PUT' : 'CALL'} ${fmtUSD(p.strike)}</span>
                <span style="color:var(--muted);font-size:11px;margin-left:6px">${p.expiry}</span>
              </div>
              <div style="text-align:right">
                <span class="${p.pnl >= 0 ? 'green' : 'red'}" style="font-weight:700">${p.pnl >= 0 ? '+' : ''}${p.pnl.toFixed(2)} USDC</span>
              </div>
            </div>
            <div style="display:flex;gap:16px;margin-top:4px;font-size:11px;color:var(--muted)">
              <span>Taille: ${p.size}</span>
              <span>Mark: ${p.markPrice.toFixed(4)}</span>
              <span>Œî ${p.delta.toFixed(3)}</span>
              <span>Œ∏ ${p.theta.toFixed(3)}</span>
            </div>
            ${d.role === 'admin' ? `<button onclick="closePosition('${p.instrument}', this)" style="background:var(--red);color:#fff;border:none;border-radius:6px;padding:4px 8px;font-size:10px;font-weight:700;cursor:pointer;margin-top:4px">CLOSE</button>` : ''}
          </div>
        `).join('')}
      </div>` : ''}
    </div>

    <!-- Prochaines Actions -->
    ${d.nextActions ? `
    <div class="section" style="border-color:rgba(246,176,107,0.3);background:linear-gradient(135deg,rgba(246,176,107,0.06),var(--card))">
      <h3>üéØ Prochaines actions <span style="font-size:10px;font-weight:400;text-transform:none;letter-spacing:0">(${d.nextActions.pctFromATH}% ATH)</span></h3>
      ${d.nextActions.warnings.length ? d.nextActions.warnings.map(w => `
        <div style="background:rgba(246,176,107,0.08);border:1px solid rgba(246,176,107,0.2);border-radius:6px;padding:6px 10px;margin-bottom:8px;font-size:11px;color:var(--accent)">‚ÑπÔ∏è ${w}</div>
      `).join('') : ''}
      ${d.nextActions.status.length ? `
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
        ${d.nextActions.status.map(s => `<span style="background:rgba(255,255,255,0.05);border-radius:6px;padding:3px 8px;font-size:11px;color:var(--muted)">${s}</span>`).join('')}
      </div>` : ''}
      ${d.nextActions.actions.map((a, i) => {
        const indented = a.startsWith('__indent__');
        const text = indented ? a.replace('__indent__', '') : a;
        return `
        <div style="display:flex;align-items:flex-start;gap:${indented ? '6' : '8'}px;padding:${indented ? '3' : '6'}px 0;${indented ? 'margin-left:24px;border-left:2px solid rgba(246,176,107,0.25);padding-left:10px;' : ''}${i < d.nextActions.actions.length - 1 && !d.nextActions.actions[i+1]?.startsWith?.('__indent__') ? 'border-bottom:1px solid var(--border)' : ''}">
          ${indented ? '' : '<span style="color:var(--accent);font-size:14px;line-height:1.2">‚Ä∫</span>'}
          <span style="font-size:${indented ? '11' : '12'}px;line-height:1.4;${indented ? 'color:var(--text)' : ''}">${text}</span>
        </div>`;
      }).join('')}

      ${d.putRecommendation ? `
      <div style="margin-top:12px;padding:10px 12px;border-radius:8px;border:1px solid ${d.putRecommendation.eligible && d.putRecommendation.needsAction ? 'rgba(110,231,160,0.4)' : 'rgba(122,114,133,0.3)'};background:${d.putRecommendation.eligible && d.putRecommendation.needsAction ? 'rgba(110,231,160,0.06)' : 'rgba(255,255,255,0.02)'}">
        <div style="font-size:12px;font-weight:700;margin-bottom:6px;color:${d.putRecommendation.eligible && d.putRecommendation.needsAction ? 'var(--green)' : 'var(--muted)'}">
          üõ°Ô∏è Prochain Put OTM ${d.putRecommendation.afterSwap ? '<span style="font-size:10px;font-weight:400;color:var(--accent)">(apr√®s prochain swap)</span>' : ''}
        </div>
        ${d.putRecommendation.eligible ? `
          <div style="font-size:11px;color:var(--muted);margin-bottom:4px">
            WBTC extra: ${fmtBTC(d.putRecommendation.wbtcExtra)} (${d.putRecommendation.wbtcExtraPct}%)${d.putRecommendation.afterSwap ? ' ‚Üí apr√®s swap: ' + fmtBTC(d.putRecommendation.wbtcExtraAfterSwap) + ' (' + d.putRecommendation.wbtcExtraPctAfterSwap + '%)' : ''} ‚Äî Cible: ${d.putRecommendation.targetCoveragePct}% couvert
          </div>
          ${d.putRecommendation.needsAction ? `
            ${!d.putRecommendation.minSizeOk ? `
              <div style="font-size:11px;color:var(--accent);margin-bottom:4px">‚è≥ Extra < 0.20 BTC ‚Äî attendre plus d'accumulation</div>
            ` : `
              <div style="font-size:13px;font-weight:600;color:var(--green);margin-bottom:4px">
                ${d.putRecommendation.afterSwap ? '5Ô∏è‚É£' : 'üõ°Ô∏è'} ACHETER ${d.putRecommendation.deficit} BTC PUT $${d.putRecommendation.strikePrice.toLocaleString()} (‚àí${d.putRecommendation.strikeOTM}% OTM) exp ${d.putRecommendation.expiry}
              </div>
              <div style="font-size:10px;color:var(--muted)">
                Couverture actuelle: ${d.putRecommendation.currentCoverage} / ${d.putRecommendation.targetSize} BTC
              </div>
            `}
          ` : `
            <div style="font-size:12px;color:var(--green)">‚úÖ Couverture OK (${d.putRecommendation.currentCoverage} / ${d.putRecommendation.targetSize} BTC)</div>
          `}
        ` : `
          <div style="font-size:11px;color:var(--muted)">${d.putRecommendation.reason}</div>
        `}
      </div>
      ` : ''}
    </div>
    ` : ''}

    <!-- R√®gles de gestion HF -->
    <div class="section">
      <h3>üìã R√®gles de gestion par Health Factor</h3>
      ${zones.map(z => `
        <div class="zone-item ${d.currentZone === z.id ? 'active' : ''}">
          <div style="display:flex;justify-content:space-between">
            <span>${z.label}</span>
            <span class="zone-price" style="color:var(--accent)">HF ${z.hf}</span>
          </div>
          <div style="font-size:10px;color:var(--muted)">${z.condition}</div>
        </div>
      `).join('')}
    </div>
    
    <div class="footer">
      <span class="live-dot"></span> Mis √† jour: ${new Date().toLocaleString('fr-FR')} ‚Äî Auto-refresh 60s<br>
      Finale Ultime - R√©partition 79/18/3 - HF Only - Puts Auto - L1 ETH<br>
      <span style="font-size: 9px; opacity: 0.7;">Version verrouill√©e le 18 f√©vrier 2026</span>
    </div>
  `;
  
  drawChart(d);
}

function drawChart(d) {
  const canvas = document.getElementById('chart');
  if (!canvas || !d.priceHistory || !d.priceHistory.length) return;
  
  const candles = d.priceHistory.map(p => ({ x: p.t, o: p.o, h: p.h, l: p.l, c: p.c }));
  
  const annotations = {};
  
  // Current price
  annotations.current = {
    type: 'line', yMin: d.price, yMax: d.price,
    borderColor: 'rgba(246,176,107,0.8)', borderWidth: 1.5,
    label: { display: true, content: fmt(Math.round(d.price)), position: 'start', backgroundColor: 'rgba(246,176,107,0.3)', color: '#f6b06b', font: { size: 10, weight: 'bold' } }
  };

  // Step lines: current step + next step down
  if (d.currentStepPrice) {
    annotations.stepCurrent = {
      type: 'line', yMin: d.currentStepPrice, yMax: d.currentStepPrice,
      borderColor: 'rgba(196,166,232,0.5)', borderWidth: 1, borderDash: [4,4],
      label: { display: true, content: 'Step ' + d.currentStep + ' ¬∑ $' + fmt(d.currentStepPrice), position: 'start', backgroundColor: 'transparent', color: 'rgba(196,166,232,0.8)', font: { size: 9 } }
    };
  }
  if (d.nextStepDown) {
    annotations.stepDown = {
      type: 'line', yMin: d.nextStepDown.prix, yMax: d.nextStepDown.prix,
      borderColor: 'rgba(248,113,113,0.5)', borderWidth: 1, borderDash: [4,4],
      label: { display: true, content: 'Step ' + d.nextStepDown.step + ' ‚ñº $' + fmt(d.nextStepDown.prix), position: 'start', backgroundColor: 'transparent', color: 'rgba(248,113,113,0.8)', font: { size: 9 } }
    };
  }

  // Chart bounds: lower = next step down, upper = max price in 24h
  const nextDown = d.nextStepDown ? d.nextStepDown.prix : d.price - d.stepSize;
  const maxPrice24h = Math.max(...candles.map(c => c.h));
  const chartMin = nextDown - d.stepSize * 0.15;
  const chartMax = maxPrice24h + d.stepSize * 0.15;

  if (chart) chart.destroy();
  
  const hasCandlestick = typeof Chart.controllers.candlestick !== 'undefined';
  
  if (hasCandlestick) {
    chart = new Chart(canvas, {
      type: 'candlestick',
      data: { datasets: [{ data: candles, color: { up: '#6ee7a0', down: '#f87171', unchanged: '#7a7285' }, borderColor: { up: '#6ee7a0', down: '#f87171', unchanged: '#7a7285' } }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { enabled: false }, annotation: { annotations } },
        scales: {
          x: { type: 'timeseries', time: { unit: 'hour', displayFormats: { hour: 'dd/MM HH:mm' } }, ticks: { color: '#7a7285', font: { size: 9 }, maxTicksLimit: 6, maxRotation: 0 }, grid: { display: false } },
          y: { display: true, min: chartMin, max: chartMax, ticks: { color: '#7a7285', font: { size: 9 }, callback: v => fmt(Math.round(v)), maxTicksLimit: 6 }, grid: { color: 'rgba(42,37,48,0.5)' } }
        }
      }
    });
  } else {
    const closes = candles.map(c => ({ x: c.x, y: c.c }));
    chart = new Chart(canvas, {
      type: 'line',
      data: { datasets: [{ data: closes, borderColor: '#f6b06b', backgroundColor: 'rgba(246,176,107,0.08)', borderWidth: 1.5, fill: true, pointRadius: 0, tension: 0.1 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false }, annotation: { annotations }, tooltip: { enabled: false } },
        scales: {
          x: { type: 'linear', ticks: { callback: v => { const dt = new Date(v); return dt.getDate() + '/' + (dt.getMonth()+1) + ' ' + dt.getHours() + 'h'; }, color: '#7a7285', font: { size: 9 }, maxTicksLimit: 6, maxRotation: 0 }, grid: { display: false } },
          y: { display: true, min: chartMin, max: chartMax, ticks: { color: '#7a7285', font: { size: 9 }, callback: v => fmt(Math.round(v)), maxTicksLimit: 6 }, grid: { color: 'rgba(42,37,48,0.5)' } }
        },
        interaction: { intersect: false, mode: 'index' }
      }
    });

    const candlePlugin = {
      id: 'candlesticks',
      afterDatasetDraw(ch) {
        const ctx = ch.ctx;
        const ys = ch.scales.y;
        const xs = ch.scales.x;
        const barW = Math.max(2, (xs.width / candles.length) * 0.6);
        candles.forEach(c => {
          const x = xs.getPixelForValue(c.x);
          const oY = ys.getPixelForValue(c.o);
          const cY = ys.getPixelForValue(c.c);
          const hY = ys.getPixelForValue(c.h);
          const lY = ys.getPixelForValue(c.l);
          const bull = c.c >= c.o;
          const color = bull ? '#6ee7a0' : '#f87171';
          ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 1;
          ctx.moveTo(x, hY); ctx.lineTo(x, lY); ctx.stroke();
          const top = Math.min(oY, cY);
          const h = Math.max(1, Math.abs(oY - cY));
          ctx.fillStyle = bull ? 'rgba(110,231,160,0.8)' : 'rgba(248,113,113,0.8)';
          ctx.fillRect(x - barW/2, top, barW, h);
        });
      }
    };
    chart.config.plugins = [candlePlugin];
    chart.update();
  }
}

let closeConfirm = {};
let fundingResetConfirm = 0;
async function resetFunding() {
  if (!fundingResetConfirm || Date.now() - fundingResetConfirm > 3000) {
    fundingResetConfirm = Date.now();
    event.target.textContent = '‚ö†Ô∏è CONFIRMER RESET';
    event.target.style.background = 'rgba(255,107,107,0.3)';
    setTimeout(() => { event.target.textContent = 'üîÑ Reset (cash sorti)'; event.target.style.background = 'rgba(255,107,107,0.15)'; }, 3000);
    return;
  }
  fundingResetConfirm = 0;
  try {
    const basePath = location.pathname.replace(/\/+$/, '');
    const res = await fetch(basePath + '/api/funding-reset', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
    const d = await res.json();
    if (d.ok) { load(); }
    else { alert('Erreur: ' + (d.error || 'inconnue')); }
  } catch(e) { alert('Erreur r√©seau'); }
}

async function closePosition(instrument, btn) {
  if (!closeConfirm[instrument] || Date.now() - closeConfirm[instrument] > 3000) {
    closeConfirm[instrument] = Date.now();
    btn.textContent = 'CONFIRMER';
    btn.style.background = '#dc4444';
    setTimeout(() => { if (btn.textContent === 'CONFIRMER') { btn.textContent = btn.dataset.origText || 'STOP'; btn.style.background = 'var(--red)'; } }, 3000);
    return;
  }
  closeConfirm[instrument] = 0;
  btn.textContent = '...';
  btn.disabled = true;
  try {
    const basePath = location.pathname.replace(/\/+$/, '');
    const res = await fetch(basePath + '/api/close-position', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ instrument })
    });
    const d = await res.json();
    if (d.ok) {
      btn.textContent = '‚úì';
      btn.style.background = 'var(--green)';
      setTimeout(load, 1500);
    } else {
      btn.textContent = d.error || 'ERREUR';
      btn.style.background = 'var(--orange)';
      setTimeout(() => { btn.textContent = 'STOP'; btn.style.background = 'var(--red)'; btn.disabled = false; }, 3000);
    }
  } catch (e) {
    btn.textContent = 'ERREUR';
    btn.style.background = 'var(--orange)';
    setTimeout(() => { btn.textContent = 'STOP'; btn.style.background = 'var(--red)'; btn.disabled = false; }, 3000);
  }
}

load();
setInterval(load, 60000);
</script>
</body>
</html>
